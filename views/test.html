<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <style>
        html, body, table,tr, td {padding:0;margin: 0;}
        #container {padding:10px;}
        #result {position: relative;border:1px solid #999; width: 100%; overflow: auto;height:100%;}
        #result input {position: absolute;top:0;left:0;}
        #console-block {height: 70px;position:absolute;}
        #console {padding: 0;margin: 0;}

        .divTable
        {
            display:  table;
            width:auto;
            border:1px solid  #666666;
            border-spacing:0px;/*cellspacing:poor IE support for  this*/
            /* border-collapse:separate;*/
        }

        .divRow
        {
            display:table-row;
            width:auto;
            clear:both;
        }

        .divCell
        {
            float:left;/*fix for  buggy browsers*/
            display:table-column;
            width:200px;
            border-right:1px solid  #666666;
            border-bottom:1px solid  #666666;
            border-collapse: collapse;
            padding:10px;
        }

        #loginForm { padding:5px; position: absolute; width: 200px; height: auto; left: 100px; top: 50px; z-index: 2; background-color: #ffffff; border: 1px solid #bababa; }
        #header {padding:10px;}
        #loginError {color: #ff0000;}
    </style>

    <script src="../public/class-extend.js"></script>
    <script data-main="./public/main.js" src="../public/require.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="../public/url.js"></script>

    <script>

        var socket = null;
        var sid = $.url('?sid');
        var myButton=null, myRootCont=null, dbc=null, dbsl=null, dbs2=null, guids=null;

        // когда документ загружен
        $(function(){
            require(
                ['socket'],
                function( Socket){
                    socket = new Socket("ws://"+url('hostname')+":8081", {
                        open: function(){ // при открытии соединения
                            // отправляем сообщение что подключились
                            socket.send({action:'connect', type:'method', sid: sid, agent:navigator.userAgent}, function(){
                                // проверяем залогинненость
                                socket.send({action:'isLogged', type:'method', sid: sid}, function(result){
                                    if (result.user) {
                                        $('#login').hide(); $('#logout').show();
                                    } else {
                                        $('#logout').hide(); $('#login').show();
                                    }
                                });
                                createController();
                            });
                        },
                        close: function(){ // при закрытии соединения

                        },
                        router: function(data){
                            console.log('сообщение с сервера:', data);
                            var result = {};
                            switch (data.action) {
                                case 'error': // ошибки
                                    console.log(data.error);
                                    break;
                                case 'sendDelta':
                                    dbc.applyDeltas(data.dbGuid, data.srcDbGuid, data.delta);
                                    break;
                            }
                            return result;
                        }
                    });
                }
            );
        });



      function createController(done){
		require(
            ['../public/memDBController', 'memDataBase'],
            function( MemDBController, MemDataBase){
                socket.send({action:"getGuids", type:'method'}, function(result){
                    guids = result;
                    // создаем  контроллер и бд
                    dbc = new MemDBController();
                    dbc.event.on({
                        type: 'applyDeltas',
                        subscriber: this,
                        callback: function(args){
                            renderAll();
                        }
                    });
					var cb = subscribeRoot;
					dbsl = dbc.newDataBase({name:"Slave1", proxyMaster : { connect: socket, guid: guids.masterGuid}},cb);
                    console.log('контроллер:', dbc);
                    console.log('база данных B:', dbsl);
                });
            }
        );
      }

      function createDataBase() {
          dbs2 = dbc.newDataBase({name:"Slave2", proxyMaster : { connect: socket, guid: dbsl.getGuid()}});
          //dbs2._buildMetaTables();
          dbs2.subscribeRoot(guids.myRootContGuid, function(result){
              console.log(result);
              createButton(dbsl, guids.myButtonGuid);
          });
          console.log('база данных C:', dbs2);
      }

      function changeCaptionMaster() {
          socket.send({action:"changeCaption", caption:'13313123'});
      }

      function subscribeRoot() {
          // подписываемся на корневой объект контейнера
		  //dbsl._buildMetaTables();
          dbsl.subscribeRoot(guids.myRootContGuid, function(result){
              console.log(result);
			  createDataBase();
          });
      }

      function changeFields(fields) {
          myButton = dbsl.getObj(guids.myButtonGuid);
          myRootCont = dbsl.getObj(guids.myRootContGuid);

          for(var name in fields)
            if (fields[name] && fields[name]!='')
                myButton.set(name, fields[name]);
          //var delta = myRootCont.getLog().genDelta();
          //console.log('delta:', delta);
		  
		  dbc.genDeltas(dbsl.getGuid());

          renderAll();



          // отправляем дельту на сервер
          //socket.send({action:"changeObj", delta:delta});
          //socket.send({action:'sendDelta', delta:delta, guidDb:dbsl.getGuid(), masterGuid:guids.masterGuid, guidRoot:myRootCont.getGuid()});

          // отправляем подписчикам своим
          //dbc.applyDelta(dbsl.getGuid(), dbsl.getGuid(), guids.myRootContGuid, delta);
      }



    /**
     * Получить  получить на клиент от сервера структуру - все сессии с номерами и когда созданы,
     * все коннекты этих сессий - с номерами и когда созданы - и чтобы эту инфо можно было вывести
     * в мемо поле по кнопке (трассировка)
     */
      function getSessions() {
          socket.send({action:"getSessions", type:'method'}, function(result){
                console.log(result);
               $('#result').append('<p>' + JSON.stringify(result.sessions) + ' </p>');
          });
      }


        var buttons = [];
        function createButton(db, guid) {
            require(
                    ['../public/ProtoControls/button'],
                    function( Button ){
                        socket.send({action:"getGuids", type:'method'}, function(result){
                            // создаем кнопку
                            var button = new Button(db, guid, {parent:'#result'});
                            buttons.push(button);
                            renderAll();
                        });
                    }
            );
        }

        function renderAll() {
          for(var i=0; i<buttons.length; i++) {
              buttons[i].render();
              var obj = buttons[i].getObj();
              if (obj.get('VerCells') && obj.get('HorCells')) {
                  renderGrid(obj.get('HorCells'),obj.get('VerCells'));
              }
          }
        }

        function renderGrid(x, y) {
            var table = $('#grid');
            if (table.length == 0) {
                table = $('<div class="divTable" id="grid"></div>');
                $('#result').append(table);
            } else {
                table.empty();
            }

            for(var i=0; i < y; i++) {
                var row  = $('<div class="divRow"></div>');
                for(var j=0; j < x; j++) {
                    var cell = $('<div class="divCell"></div>');
                    row.append(cell);
                }
                table.append(row);
            }

        }

        /**
         * Логин
         * @param name
         * @param pass
         */
        function login(name, pass){
            // логинимся
            socket.send({action:'login', type:'method', name:name, pass:pass, sid: sid}, function(result){
                if (result.user) {
                    $('#login').hide(); $('#logout').show();
                    $('#loginForm').hide();
                    $('#loginError').hide();

                } else {
                    $('#logout').hide(); $('#login').show();
                    $('#loginError').html('Неправильный логин или пароль').show();
                }
            });
        }

        /**
         * Выход
         */
        function logout(){
            socket.send({action:'logout', type:'method', sid: sid}, function(result){
                $('#logout').hide(); $('#login').show();
            });
            return false;
        }

        $(function(){

            // высота окошка результатов
            function fixHeight() {
                $('#result').height($(window).height()-120);
                $('#console').width('100%');
            };
            fixHeight();
            $(window).resize(fixHeight);

            // форма логина
            $('#login').click(function(e){
                e.stopPropagation();
                if ($('#loginForm').is(':visible')) {
                    $('#loginForm').hide();
                } else {
                    var offset = $(this).offset();
                    offset.top += 20;
                    $('#loginForm').show().offset(offset);
                }
                return false;
            });
            $(window).click(function(){$('#loginForm').hide();});
            $('#loginForm').click(function(e){e.stopPropagation();});
        });




    </script>
</head>
<body>

<div id="header">
    <a href="#" id="login" style="display: none;">Войти</a>
    <a href="#" id="logout" style="display: none;" onclick="return logout();">Выйти</a>
</div>

<div id="interface">
    Caption:<input type="text" value="" id="myButtonCaption">
    Top:<input type="text" value="" id="myButtonTop">
    Left:<input type="text" value="" id="myButtonLeft">
    HorCells:<input type="text" value="" id="HorCells">
    VerCells:<input type="text" value="" id="VerCells">
    <input type="button" value="Поменять" onclick="changeFields({VerCells:$('#VerCells').val(), HorCells:$('#HorCells').val(), Caption:$('#myButtonCaption').val(), Top:$('#myButtonTop').val(), Left:$('#myButtonLeft').val()});"><br>
    <input type="button" value="Трассировка" onclick="getSessions();">
    <input type="button" value="renderAll" onclick="renderAll();">

    <div id="container">
        <div id="result"></div>
    </div>
</div>

<div id="loginForm" style="display: none;">
    <div id="loginError"></div>
    Имя:<input type="text" value="user" id="loginName"><br>
    Пароль:<input type="password" value="123" id="loginPass"><br>
    <input type="button" value="Войти" onclick="login($('#loginName').val(), $('#loginPass').val())">
</div>

</body>
</html>