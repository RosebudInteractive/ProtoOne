<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <style>
        html, body, table,tr, td {padding:0;margin: 0;}
        #container {padding:10px;}
        #result {border:1px solid #999; width: 100%; overflow: auto;height:100%;}
        #console-block {height: 70px;position:absolute;}
        #console {padding: 0;margin: 0;}
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="./public/url.js"></script>
    <script>
        /**
         * Выполнение команды
         * @param command Формат comand param1,param2,...paramN
         */
        function runCommand(command, viewResult, clearConsole) {
            var items = command.split(' ', 2);
            var func = items[0];

            var params = items[1];
            if (eval("typeof " + func) !== 'function'){
                $('#result').append('<p>Функция `'+func+'` не найдена</p>');
            }

            var result = eval(func+'('+params+')');
            if (viewResult)
                $('#result').append('<p>Результат '+ func +'('+params+'): '+result+' </p>');
            if (clearConsole)
                $('#console').val('');
        }


        // инициализация
        $(function(){
            function fixHeight() {
              $('#result').height($(window).height()-90);
              $('#console').width('100%');
            };
            fixHeight();
            $(window).resize(fixHeight);

            // click enter
            $("#console").keyup(function(event){
                if(event.keyCode == 13){
                    event.preventDefault();
                    event.stopPropagation();
                    runCommand($('#console').val());
                }
            });
        });

        // работа с сокетами
        if (!window.WebSocket) {
            document.body.innerHTML = 'WebSocket в этом браузере не поддерживается.';
        }
        // создать подключение
        var socket = new WebSocket("ws://"+url('hostname')+":8081");

        socket.onopen = function(event) {
            // отправляем сообщение что подключились
            socket.send(JSON.stringify({action:'connect', sid: $.url('?sid'), agent:navigator.userAgent}));
            // пингует раз в секунду сервер раз в секунду
            setInterval(function(){
                socket.send(JSON.stringify({action:'ping', sid: $.url('?sid')}));
            }, 1000);
        };

        // обработчик входящих сообщений
        socket.onmessage = function(event) {
            var data = JSON.parse(event.data);
            switch (data.action) {
                case 'sessions':
                    console.log(data.sessions);
                    break;
            }
        };

        // команда SESSIONS (S)
        var s = S = SESSIONS = function(){
            socket.send(JSON.stringify({action:'sessions', sid: $.url('?sid')}));
        };

    </script>
</head>
<body>

<div id="container">
<div id="result"></div>
<div id="console-block"><table width="100%">
    <tr>
        <td width="100%"><textarea name="console" id="console" style="width: 100%;" rows="3"></textarea></td>
        <td width="120"><input type="button" onclick="runCommand($('#console').val(), false, true);" value="Выполнить"/><br>
            <input type="button" onclick="$('#console').val('');" value="Очистить"/>
        </td>
    </tr>
</table>
</div>
</div>

</body>
</html>