<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <script src="./public/class-extend.js"></script>
    <script data-main="./public/main.js" src="./public/require.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

    <script>
        
        function execServerCode() {
            $.ajax({
                url: "http://127.0.0.1:1325/"
            }).done(function(data) {
                $('#result').append('<p>Результат серверного кода: ' + data + '</p>');
            });
        }

        function setCache(name, value){
            $.ajax({
                url: "http://127.0.0.1:1325/setcache",
                data: {'name':name, 'value':value}
            }).done(function(data) {
                $('#result').append('<p>Переменная "'+name+'" установлена: ' + value + '</p>');
            }).fail(function() {
                $('#result').html('error');
            });
        }
        function getCache(name){
            $.ajax({
                url: "http://127.0.0.1:1325/getcache",
                data: {'name':name}
            }).done(function(data) {
                $('#result').append('<p>Значение переменной "'+name+'" равно: ' + data + '</p>');
            }).fail(function(err) {
                $('#result').append('<p>error</p>');
            });
        }


        // работа с сокетами
        if (!window.WebSocket) {
            document.body.innerHTML = 'WebSocket в этом браузере не поддерживается.';
        }
        // создать подключение
        var socket = new WebSocket("ws://localhost:8081");

        // обработчик входящих сообщений
        socket.onmessage = function(event) {
            console.log(event)
            var data = JSON.parse(event.data);
            switch (data.action) {
                case 'addobject':
                    $('#result').append('<p>Объект '+data.type+' c именем "'+data.name+'" добавлен</p>');
                    break;
                case 'getlistobject':
                    $('#result').append('<p>Список объектов '+data.type+'s: "'+data.names+'"</p>');
                    break;
                case 'newconn':
                    $('#result').append('<p>'+data.name+'</p>');
                    break;
            }
        };

        function addObject(name, type){
            socket.send(JSON.stringify({action:'addobject', type:type, name:name}));
        }
        function getListobject(type){
            socket.send(JSON.stringify({action:'getlistobject', type:type}));
        }
		

		require(
            ['memDBController','memDataBase','memMetaObj','memMetaObjFields','memMetaObjCols','memObj'],
            function( MemDBController,MDb,MemMetaObj,MemMetaObjFields,MemMetaObjCols,MemObj){
			
				var dbc = new MemDBController();
                var db = dbc.newDataBase({name:"Master", kind : "master"}); 
				var dbsl = dbc.newDataBase({name:"Slave", kind : "slave", local: true, masterGuid : db.getGuid()}); 
				
				//var myMetaField = new MemMetaField(db);
				//var myMetaXObj = new MemMetaXObj(db); // должен создаваться автоматом при инициализации базы
								
				var myMetaControl = new MemMetaObj(db,{"typeName": "Control", "parentClass":null});
				var myMetaButton = new MemMetaObj(db,{"typeName": "Button", "parentClass":myMetaControl});
				var flds = myMetaControl.getCol("fields");
				var cls = myMetaControl.getCol("cols");
				new MemMetaObjFields({"obj": myMetaControl, "colName": "fields"}, {"fname":"Id","ftype":"int"});
				new MemMetaObjFields({"obj": myMetaControl, "colName": "fields"}, {"fname":"Name","ftype":"string"});
				new MemMetaObjFields({"obj": myMetaButton, "colName": "fields"}, {"fname":"Caption","ftype":"string"});
				myMetaControl._bldElemTable(); // temp
				myMetaButton._bldElemTable();

				// то же самое для slave				
				var my2MetaControl = new MemMetaObj(dbsl,{"typeName": "Control", "parentClass":null});
				var my2MetaButton = new MemMetaObj(dbsl,{"typeName": "Button", "parentClass":my2MetaControl});
				var flds2 = my2MetaControl.getCol("fields");
				var cls2 = my2MetaControl.getCol("cols");
				new MemMetaObjFields({"obj": my2MetaControl, "colName": "fields"}, {"fname":"Id","ftype":"int"});
				new MemMetaObjFields({"obj": my2MetaControl, "colName": "fields"}, {"fname":"Name","ftype":"string"});
				new MemMetaObjFields({"obj": my2MetaButton, "colName": "fields"}, {"fname":"Caption","ftype":"string"});
				my2MetaControl._bldElemTable(); // temp
				my2MetaButton._bldElemTable();

				
				//var myRootButton = new MemObj(myMetaButton,{ "db": db, "mode":"RW" },{"Id":22,"Name":"MyFirstButton","Caption":"OK"});
				myRootButton = db.newRootObj(myMetaButton,{"Id":22,"Name":"MyFirstButton","Caption":"OK"});
				var lid1 = myRootButton.getLid();
				
				myRootButton.set("Caption","Cancel");
				
				var delta = myRootButton.getLog().genDelta();
				
				var obj1=dbsl.subscribeRoot(lid1);
				
				//dbsl.subscribe(db.getGuid());
				
				console.log(obj1);
            }
        );
		

    </script>
</head>
<body>

<h3>Работа с объектами</h3>
<form method="post" action="">
    Имя:<br>
    <input type="text" value="" id="objName" /><br>
    <input type="button" value="Add User" onclick="addObject($('#objName').val(), 'user');" /><br>
    <input type="button" value="Add Admin" onclick="addObject($('#objName').val(), 'admin');" /><br>
    <input type="button" value="GetList Users" onclick="getListobject('user');" /><br>
    <input type="button" value="GetList Admins" onclick="getListobject('admin');" /><br>
</form>



<h3>Результаты работы:</h3>
<div id="result" style="border:1px solid #999;padding: 10px; height: 200px;overflow: auto;"></div>
<input type="button" onclick="$('#result').html('');" value="Очистить"/>
</body>
</html>